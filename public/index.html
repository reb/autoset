<html>
<head>
  <script>
    function hasGetUserMedia() {
      return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
    }

    if (hasGetUserMedia()) {
      // Good to go!
    } else {
      alert('getUserMedia() is not supported by your browser');
    }

    function init() {
      const constraints = {
        video: true
      };

      navigator.mediaDevices.enumerateDevices()
        .then(gotDevices)
        .then(getStream)
        .catch(handleError);

      const videoSelect = document.querySelector('select#videoSource');
      videoSelect.onchange = getStream;

    }

    function gotDevices(deviceInfos) {
      const videoSelect = document.querySelector('select#videoSource');
      const videoDevices = deviceInfos.filter(deviceInfo => deviceInfo.kind === 'videoinput');
      if (videoDevices.length === 0) {
        alert('No video inputs found :(');
      } else {
        videoDevices.forEach(deviceInfo => {
          const option = document.createElement('option');
          option.value = deviceInfo.deviceId;
          option.text = deviceInfo.label || 'camera ' + (videoSelect.length + 1);
          videoSelect.appendChild(option);
        });
      }
    }

    function getStream() {
      const videoSelect = document.querySelector('select#videoSource');
      if (window.stream) {
        window.stream.getTracks().forEach(function(track) {
          track.stop();
        });
      }

      const constraints = {
        video: {
          deviceId: {exact: videoSelect.value}
        }
      };

      navigator.mediaDevices.getUserMedia(constraints).
        then(gotStream).catch(handleError);
    }

    function gotStream(stream) {
      const video = document.querySelector('video');
      window.stream = stream; // make stream available to console
      video.srcObject = stream;
    }

    function handleError(error) {
      console.error('Error: ', error);
    }

    function capture() {
      const canvas = document.querySelector('canvas');
      const video = document.querySelector('video');
      const preview = document.querySelector('img');

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      
      const imageData = canvas.toDataURL('image/jpeg');
      
      preview.src = imageData;

      const xhr = new XMLHttpRequest();
      xhr.open('POST', 'https://europe-west1-strong-jetty-243820.cloudfunctions.net/find-set', true);
      xhr.setRequestHeader('Content-Type', 'application/json; charset=utf-8');
      xhr.upload.onprogress = function(event) {
        console.log('progress', event);
      };
      xhr.onload = function(event) {
        console.log('loaded', event);
        const result = JSON.parse(xhr.responseText);
        if (result.length > 0) {
          alert('Set!');
        } else {
          alert('No set :(');
        }
      };
      xhr.send(JSON.stringify({image: imageData.replace(/^data:image\/[^;]+;base64,/, '')}));
    }
  </script>
</head>
<body onload="init()">
  <video autoplay onclick="capture()"></video>
  <img src="">
  <canvas style="display:none;"></canvas>
  <select id="videoSource"></select>
</body>
</html>
